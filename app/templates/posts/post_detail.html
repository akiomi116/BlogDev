{# F:\dev\BrogDev\app\templates\posts\post_detail.html #}

{% extends "base.html" %}

{% block title %}{{ post.title }} - My Blog{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-lg-10 offset-lg-1">
            <h1 class="mb-3">{{ post.title }}</h1>
            
            <p class="text-muted small mb-4">
                <i class="fas fa-user me-1"></i> 投稿者: {{ post.posted_by.username if post.posted_by else '不明' }}
                <span class="mx-2">|</span>
                <i class="fas fa-calendar-alt me-1"></i> 投稿日: {{ post.created_at.strftime('%Y年%m月%d日 %H:%M') }}
                {% if post.updated_at %}
                    <span class="mx-2">|</span>
                    <i class="fas fa-sync-alt me-1"></i> 更新日: {{ post.updated_at.strftime('%Y年%m月%d日 %H:%M') }}
                {% endif %}
                {% if post.category %}
                    <span class="mx-2">|</span>
                    <i class="fas fa-folder me-1"></i> カテゴリ: <a href="{{ url_for('home.posts_by_category', category_id=post.category.id) }}">{{ post.category.name }}</a>
                {% endif %}
            </p>

            {% if post.main_image %}
                <div class="mb-4 text-center">
                    <img src="{{ post.main_image.url }}" class="img-fluid rounded shadow-sm" 
                         alt="{{ post.main_image.alt_text or post.title }}" 
                         style="max-height: 400px; object-fit: contain;">
                    {% if post.main_image.alt_text %}
                        <small class="text-muted d-block mt-2">{{ post.main_image.alt_text }}</small>
                    {% endif %}
                </div>
            {% else %}
                <div class="mb-4 text-center">
                    <img src="{{ url_for('static', filename='images/no_image.png') }}" class="img-fluid rounded shadow-sm" 
                         alt="No Image Set" 
                         style="max-height: 400px; object-fit: contain;">
                    <small class="text-muted d-block mt-2">メイン画像は設定されていません。</small>
                </div>
            {% endif %}

            <div class="post-content mt-5 border-top pt-4">
                {# ★ここを修正: | safe フィルターを追加してHTMLをエスケープ解除★ #}
                {{ post.body | markdown_to_html | safe }} 
            </div>

            {% if post.tags %}
                <div class="mt-4 border-top pt-3">
                    <i class="fas fa-tags me-2"></i>タグ:
                    {% for tag in post.tags %}
                        <a href="{{ url_for('home.posts_by_tag', tag_id=tag.id) }}" class="badge bg-secondary me-1">{{ tag.name }}</a>
                    {% endfor %}
                </div>
            {% endif %}

            <div class="mt-5 text-center">
                <a href="{{ url_for('home.index') }}" class="btn btn-secondary"><i class="fas fa-arrow-left me-2"></i>ホームに戻る</a>
            </div>

            <div class="mt-5">
                <h4>コメント</h4>
                {% for comment in post.comments %}
                    <div class="border rounded p-3 mb-3">
                        <div class="d-flex justify-content-between">
                            <strong>{{ comment.author_name }}</strong>
                            <span class="text-muted small">{{ comment.created_at.strftime('%Y年%m月%d日 %H:%M') }}</span>
                        </div>
                        <div class="mt-2">
                            {{ comment.content | safe }}
                        </div>
                    </div>
                {% else %}
                    <div class="text-center text-muted py-3">
                        まだコメントはありません。
                    </div>
                {% endfor %}

                <form method="POST" action="">
                    {{ comment_form.csrf_token }}
                    <div class="mb-3">
                        {{ comment_form.author_name.label(class="form-label") }}
                        {{ comment_form.author_name(class="form-control") }}
                        {% for error in comment_form.author_name.errors %}
                            <div class="text-danger">{{ error }}</div>
                        {% endfor %}
                    </div>
                    <div class="mb-3">
                        {{ comment_form.body.label(class="form-label") }}
                        {{ comment_form.body(class="form-control") }}
                        {% for error in comment_form.body.errors %}
                            <div class="text-danger">{{ error }}</div>
                        {% endfor %}
                    </div>
                    {{ comment_form.submit(class="btn btn-primary") }}
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{# Jinja2カスタムフィルターの定義は、FlaskのPythonコード側 (app/__init__.pyなど) で行われるべきです。
   テンプレート内でのマクロ定義は、Python側のフィルターが機能している場合は不要です。
   もしPython側のフィルターが機能しない場合のフォールバックとして残すのであれば、
   単にcontentをsafeに出力する形に変更してください。
#}
{#
{% macro markdown_to_html(content) %}
    {{ content | safe }} 
{% endmacro %}
#}
